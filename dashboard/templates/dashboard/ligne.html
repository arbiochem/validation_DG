{% load l10n %}

<style>
    /* Table responsive */
    .table-wrapper {
        overflow-x: auto; /* Permet le scroll horizontal sur mobile */
        width: 100%;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 8px 10px;
        text-align: center;
        border: 1px solid #ccc;
        white-space: nowrap; /* Emp√™che le texte de casser en plusieurs lignes */
    }

    /* Couleurs pour la cellule editable */
    .qte-cell {
        background-color: #007BFF;
        color: white;
    }

    /* Boutons */
    .btn-action i, .btn-save {
        font-size: 16px;
    }

    /* Centrage */
    .text-center {
        text-align: center;
    }

    /* Responsive : r√©duire police et padding sur petits √©crans */
    @media (max-width: 768px) {
        th, td {
            padding: 6px 4px;
            font-size: 12px;
        }

        .btn-action i, .btn-save {
            font-size: 14px;
        }
    }

    @media (max-width: 480px) {
        th, td {
            padding: 4px 2px;
            font-size: 10px;
        }

        .btn-action i, .btn-save {
            font-size: 12px;
        }
    }

    .toast-success .toast-header { background-color: #e6f4ea; }
    .toast-success .toast-title { color: #0f5132; }
    .toast-error .toast-header { background-color: #f8d7da; }
    .toast-error .toast-title { color: #842029; }
    .toast-info .toast-header { background-color: #cff4fc; }
    .toast-info .toast-title { color: #055160; }
</style>

<!-- CONFIRMATION MODALE -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-2">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold" id="confirmModalTitle">Confirmation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>

      <div class="modal-body">
        <div class="d-flex align-items-start">
          <div class="me-3">
            <!-- Ic√¥ne -->
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="#ff8800"
                 class="bi bi-exclamation-triangle-fill">
              <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.71c.889 0 1.437-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm0 7a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
          </div>

          <div>
            <p id="confirmModalMessage" class="mb-0 fs-5"></p>
          </div>
        </div>
      </div>

      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" id="confirmModalCancel">Annuler</button>
        <button type="button" class="btn btn-danger fw-bold" id="confirmModalOk">Confirmer</button>
      </div>
    </div>
  </div>
</div>


{% for ligne in lignes %}
    <tr class="ligne" data-id="{{ ligne.cbMarq }}" 
        data-prix="{{ ligne.DL_PrixUnitaire|floatformat:2|localize }}" 
        data-frais="{{ ligne.DL_Frais|floatformat:2|localize }}">
        <td>{{ ligne.AR_Ref }}</td>
        <td>{{ ligne.DL_DESIGN }}</td>
        <td class="qte-cell" contenteditable="true" 
            data-row-id="{{ ligne.cbMarq }}"
            style="text-align: center; background-color: blue; color:white">{{ ligne.DL_QTE|floatformat:2|localize }}</td>
        <td class="prix-cell" style="text-align: center;">{{ ligne.DL_PrixUnitaire|floatformat:2|localize }}</td>
        <td class="frais-cell" style="text-align: center;">{{ ligne.DL_Frais|floatformat:2|localize }}</td>
        <td class="montant-cell" data-row-id="{{ ligne.cbMarq }}" style="text-align: center;">{{ ligne.DL_MontantTTC|floatformat:2|localize }}</td>
        <td class="text-center">
            <button class="btn btn-sm btn-success btn-save" data-row-id="{{ ligne.cbMarq }}" type="button" title="Enregistrer">
                üíæ
            </button>
            <a href="#" class="btn btn-sm btn-danger btn-action btn-delete" data-row-id="{{ ligne.cbMarq }}" title="Supprimer">
                <i class="bi bi-trash"></i>
            </a>
        </td>
    </tr>
{% endfor %}

<script>
console.log('=== SCRIPT CHARGE ===');

function showNotify(type, message, options = {}) {
  const container = document.getElementById('toast-container');
  const template = document.getElementById('toast-template');

  const title = options.title || (type === 'success' ? 'Succ√®s' : type === 'error' ? 'Erreur' : 'Info');
  const delay = options.delay ?? 4500;
  const autohide = options.autohide ?? true;
  const showProgress = options.progress ?? true;

  // clone template
  const toastEl = template.cloneNode(true);
  toastEl.id = ''; // remove id
  toastEl.hidden = false;
  toastEl.classList.add('toast-' + type);
  toastEl.style.minWidth = '280px';
  toastEl.style.marginBottom = '0.5rem';

  // set texts
  toastEl.querySelector('.toast-title').textContent = title;
  toastEl.querySelector('.toast-time').textContent = new Date().toLocaleTimeString();
  toastEl.querySelector('.toast-message').innerHTML = message;

  // progress bar element
  const progressBar = toastEl.querySelector('.toast-progress-bar');
  if (!showProgress) {
    progressBar.style.display = 'none';
  } else {
    progressBar.style.transition = `transform ${delay}ms linear`;
    progressBar.style.transform = 'scaleX(1)';
  }

  // append
  container.appendChild(toastEl);

  // create bootstrap toast instance
  const bsToast = new bootstrap.Toast(toastEl, { autohide: autohide, delay: delay });
  bsToast.show();

  // start progress animation shortly after showing
  if (showProgress) {
    // Force reflow then animate (transform: scaleX(0) to shrink left-to-right)
    requestAnimationFrame(() => {
      // set initial to full, then to 0
      progressBar.style.transformOrigin = 'left';
      // small timeout to ensure transition applies
      setTimeout(() => progressBar.style.transform = 'scaleX(0)', 20);
    });
  }

  // cleanup when hidden
  toastEl.addEventListener('hidden.bs.toast', () => {
    toastEl.remove();
  });

  return bsToast;
}

function notifyConfirm(message, options = {}) {
  return new Promise((resolve, reject) => {

    const modalEl = document.getElementById("confirmModal");

    const title = options.title ?? "Confirmation";
    const okText = options.okText ?? "Confirmer";
    const cancelText = options.cancelText ?? "Annuler";
    const okClass = options.okClass ?? "btn-danger";
    const cancelClass = options.cancelClass ?? "btn-secondary";

    modalEl.querySelector("#confirmModalTitle").textContent = title;
    modalEl.querySelector("#confirmModalMessage").textContent = message;

    const btnOk = modalEl.querySelector("#confirmModalOk");
    const btnCancel = modalEl.querySelector("#confirmModalCancel");

    // Reset classes
    btnOk.className = "btn " + okClass + " fw-bold";
    btnCancel.className = "btn " + cancelClass;

    btnOk.textContent = okText;
    btnCancel.textContent = cancelText;

    const modal = new bootstrap.Modal(modalEl);

    // Nettoyage des anciens events
    btnOk.onclick = () => {
      modal.hide();
      resolve(true);
    };

    btnCancel.onclick = () => {
      modal.hide();
      reject(false);
    };

    modal.show();
  });

// helper for common types
function notifySuccess(msg, opts) { return showNotify('success', msg, opts); }
function notifyError(msg, opts) { return showNotify('error', msg, opts); }
function notifyInfo(msg, opts) { return showNotify('info', msg, opts); }

// Utiliser la d√©l√©gation d'√©v√©nements sur le document
document.addEventListener('input', function(e) {
    // V√©rifier si c'est une cellule de quantit√©
    if (e.target && e.target.classList.contains('qte-cell')) {
        //console.log('Modification de quantit√© d√©tect√©e');
        
        const qteCell = e.target;
        const row = qteCell.closest('tr');
        
        if (!row) {
            console.error('Ligne parente non trouv√©e');
            return;
        }
        
        const prixCell = row.querySelector('.prix-cell');
        const fraisCell = row.querySelector('.frais-cell');
        const montantCell = row.querySelector('.montant-cell');
        
        if (!prixCell || !fraisCell || !montantCell) {
            console.error('Cellules non trouv√©es');
            return;
        }
        
        // R√©cup√©rer les valeurs
        const qteText = qteCell.textContent.trim();
        const prixText = prixCell.textContent.trim();
        const fraisText = fraisCell.textContent.trim();
        
        //console.log('Valeurs brutes:', { qte: qteText, prix: prixText, frais: fraisText });
        
        // Convertir en nombres
        const qte = parseFloat(qteText.replace(/\s/g, '').replace(',', '.')) || 0;
        const prix = parseFloat(prixText.replace(/\s/g, '').replace(',', '.')) || 0;
        const frais = parseFloat(fraisText.replace(/\s/g, '').replace(',', '.')) || 0;
        
        //console.log('Valeurs num√©riques:', { qte, prix, frais });
        
        // Calculer le montant
        const montant = (qte * prix) + frais;
        //console.log('Montant calcul√©:', montant);
        
        // Afficher le r√©sultat
        montantCell.textContent = new Intl.NumberFormat('fr-FR', { 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 2 
        }).format(montant);
        //console.log('Nouveau montant affich√©:', montantCell.textContent);
    }
});

// Gestion des clics sur les boutons save avec d√©l√©gation
document.addEventListener('click', function(e) {
    // V√©rifier si c'est un bouton save
    if (e.target && (e.target.classList.contains('btn-save') || e.target.closest('.btn-save'))) {
        e.preventDefault();
        
        const btn = e.target.classList.contains('btn-save') ? e.target : e.target.closest('.btn-save');
        const row = btn.closest('tr');
        
        if (!row) {
            console.error('Ligne non trouv√©e');
            return;
        }
        
        const id = row.dataset.id;
        //console.log('Sauvegarde ligne ID:', id);
        
        const data = {
            do_piece: "{{do_piece}}",
            AR_Ref: row.cells[0].textContent.trim(),
            DL_DESIGN: row.cells[1].textContent.trim(),
            DL_QTE: parseFloat(row.cells[2].textContent.replace(/\s/g, '').replace(',', '.')) || 0,
            DL_PrixUnitaire: parseFloat(row.cells[3].textContent.replace(/\s/g, '').replace(',', '.')) || 0,
            DL_Frais: parseFloat(row.cells[4].textContent.replace(/\s/g, '').replace(',', '.')) || 0,
            DL_MontantTTC: parseFloat(row.cells[5].textContent.replace(/\s/g, '').replace(',', '.')) || 0
        };
        
        //console.log('Donn√©es √† envoyer:', data);
        
        // Fonction pour r√©cup√©rer le cookie CSRF
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        ids = id.toString().trim();          // retire les espaces au d√©but/fin
        idss = ids.replace(/\s/g, '');

        fetch(`/dashboard/modifier_ligne/${idss}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(res => {
            if (!res.ok) throw new Error('Erreur serveur: ' + res.status);
            return res.json();
        })
        .then(res => {
            console.log('R√©ponse:', res);
            if(res.success){
                notifySuccess('Ligne mise √† jour avec succ√®s !', { delay: 3500 });
            } else {
                notifyError('Erreur: ' + (res.message || 'Erreur inconnue'), { delay: 3500 });
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            notifyError('Erreur: ' + error.message);
        });
    }
    
    // Gestion du bouton supprimer
    if (e.target && (e.target.classList.contains('btn-delete') || e.target.closest('.btn-delete'))) {
    e.preventDefault();

    notifyConfirm("Voulez-vous vraiment supprimer cette ligne ?")
        .then(() => {

            const btn = e.target.classList.contains('btn-delete') 
                ? e.target 
                : e.target.closest('.btn-delete');

            const row = btn.closest('tr');
            const id = row.dataset.id.trim().replace(/\s/g, '');

            console.log("Suppression ligne ID:", id);

            // Cookie CSRF
            function getCookie(name) {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + "=")) {
                        return decodeURIComponent(cookie.substring(name.length + 1));
                    }
                }
                return null;
            }

            // Suppression AJAX
            fetch(`/dashboard/modifier_ligne/${id}/`, {
                method: "DELETE",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken")
                }
            })
            .then(res => res.json())
            .then(res => {
                if (res.success) {
                    notifySuccess("Ligne supprim√©e !");
                    row.remove(); // supprime directement la ligne du tableau
                } else {
                    notifyError("Erreur : " + res.message);
                }
            })
            .catch(err => notifyError("Erreur r√©seau : " + err));
        })
        .catch(() => {
            notifyInfo("Suppression annul√©e.");
        });
    }
  });
}

console.log('=== SCRIPT CONFIGURE (d√©l√©gation d\'√©v√©nements) ===');
</script>