{% load l10n %}

<style>
    /* Table responsive */
    .table-wrapper {
        overflow-x: auto; /* Permet le scroll horizontal sur mobile */
        width: 100%;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 8px 10px;
        text-align: center;
        border: 1px solid #ccc;
        white-space: nowrap; /* Emp√™che le texte de casser en plusieurs lignes */
    }

    /* Couleurs pour la cellule editable */
    .qte-cell {
        background-color: #007BFF;
        color: white;
    }

    /* Boutons */
    .btn-action i, .btn-save {
        font-size: 16px;
    }

    /* Centrage */
    .text-center {
        text-align: center;
    }

    /* Responsive : r√©duire police et padding sur petits √©crans */
    @media (max-width: 768px) {
        th, td {
            padding: 6px 4px;
            font-size: 12px;
        }

        .btn-action i, .btn-save {
            font-size: 14px;
        }
    }

    @media (max-width: 480px) {
        th, td {
            padding: 4px 2px;
            font-size: 10px;
        }

        .btn-action i, .btn-save {
            font-size: 12px;
        }
    }

    .toast-success .toast-header { background-color: #e6f4ea; }
    .toast-success .toast-title { color: #0f5132; }
    .toast-error .toast-header { background-color: #f8d7da; }
    .toast-error .toast-title { color: #842029; }
    .toast-info .toast-header { background-color: #cff4fc; }
    .toast-info .toast-title { color: #055160; }
</style>

<!-- CONFIRMATION MODALE -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-2">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold" id="confirmModalTitle">Confirmation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>

      <div class="modal-body">
        <div class="d-flex align-items-start">
          <div class="me-3">
            <!-- Ic√¥ne -->
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="#ff8800"
                 class="bi bi-exclamation-triangle-fill">
              <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.71c.889 0 1.437-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm0 7a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
          </div>

          <div>
            <p id="confirmModalMessage" class="mb-0 fs-5"></p>
          </div>
        </div>
      </div>

      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" id="confirmModalCancel">Annuler</button>
        <button type="button" class="btn btn-danger fw-bold" id="confirmModalOk">Confirmer</button>
      </div>
    </div>
  </div>
</div>


{% for ligne in lignes %}
    <tr class="ligne" data-id="{{ ligne.cbMarq }}" 
        data-prix="{{ ligne.DL_PrixUnitaire|floatformat:2|localize }}" 
        data-frais="{{ ligne.DL_Frais|floatformat:2|localize }}">
        <td>{{ ligne.AR_Ref }}</td>
        <td>{{ ligne.DL_DESIGN }}</td>
        <td class="qte-cell" contenteditable="true" 
            data-row-id="{{ ligne.cbMarq }}"
            style="text-align: center; background-color: blue; color:white">{{ ligne.DL_QTE|floatformat:2|localize }}</td>
        <td class="prix-cell" style="text-align: center;">{{ ligne.DL_PrixUnitaire|floatformat:2|localize }}</td>
        <td class="frais-cell" style="text-align: center;">{{ ligne.DL_Frais|floatformat:2|localize }}</td>
        <td class="montant-cell" data-row-id="{{ ligne.cbMarq }}" style="text-align: center;">{{ ligne.DL_MontantTTC|floatformat:2|localize }}</td>
        <td class="text-center">
            <button class="btn btn-sm btn-success btn-save" data-row-id="{{ ligne.cbMarq }}" type="button" title="Enregistrer">
                üíæ
            </button>
            <a href="#" class="btn btn-sm btn-danger btn-action btn-delete" data-row-id="{{ ligne.cbMarq }}" title="Supprimer">
                <i class="bi bi-trash"></i>
            </a>
        </td>
    </tr>
{% endfor %}

<script>
// Utiliser la d√©l√©gation d'√©v√©nements sur le document
document.addEventListener('input', function(e) {
    if (e.target && e.target.classList.contains('qte-cell')) {
        updateMontant(e.target);
    }
}, true); // true = capture

document.addEventListener('click', function(e) {
    // -----------------------
    // Bouton SAVE
    // -----------------------
    if (e.target && (e.target.classList.contains('btn-save') || e.target.closest('.btn-save'))) {
        e.preventDefault();

        const btn = e.target.classList.contains('btn-save') ? e.target : e.target.closest('.btn-save');
        const row = btn.closest('tr');
        if (!row) return;

        const id = row.dataset.id;
        const data = {
            do_piece: "{{do_piece}}",
            AR_Ref: row.cells[0].textContent.trim(),
            DL_DESIGN: row.cells[1].textContent.trim(),
            DL_QTE: parseFloat(row.cells[2].textContent.replace(/\s/g, '').replace(',', '.')) || 0,
            DL_PrixUnitaire: parseFloat(row.cells[3].textContent.replace(/\s/g, '').replace(',', '.')) || 0,
            DL_Frais: parseFloat(row.cells[4].textContent.replace(/\s/g, '').replace(',', '.')) || 0,
            DL_MontantTTC: parseFloat(row.cells[5].textContent.replace(/\s/g, '').replace(',', '.')) || 0
        };

        function getCookie(name) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + "=")) {
                    return decodeURIComponent(cookie.substring(name.length + 1));
                }
            }
            return null;
        }

        ids = id.toString().trim();          // retire les espaces au d√©but/fin
        idss = ids.replace(/\s/g, '');

        fetch(`/dashboard/modifier_ligne/${idss}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(res => {
            if (!res.ok) throw new Error('Erreur serveur: ' + res.status);
            return res.json();
        })
        .then(res => {
            if(res.success){
                alert('Ligne mise √† jour avec succ√®s !');
            } else {
                alert('Erreur: ' + (res.message || 'Erreur inconnue'));
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur: ' + error.message);
        });
    }

    // -----------------------
    // Bouton DELETE
    // -----------------------
    if (e.target && (e.target.classList.contains('btn-delete') || e.target.closest('.btn-delete'))) {
        e.preventDefault();

        const btn = e.target.classList.contains('btn-delete') ? e.target : e.target.closest('.btn-delete');
        const row = btn.closest('tr');
        if (!row) return;

        const id = row.dataset.id.trim().replace(/\s/g, '');
        console.log("Suppression ligne ID:", id);

        if (confirm("Voulez-vous vraiment supprimer cette ligne ?")) {
            function getCookie(name) {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + "=")) {
                        return decodeURIComponent(cookie.substring(name.length + 1));
                    }
                }
                return null;
            }

            fetch(`/dashboard/modifier_ligne/${id}/`, {
                method: "DELETE",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken")
                }
            })
            .then(res => res.json())
            .then(res => {
                if (res.success) {
                    alert("Ligne supprim√©e !");
                    row.remove();
                } else {
                    alert("Erreur : " + res.message);
                }
            })
            .catch(err => alert("Erreur r√©seau : " + err));
        } else {
            console.log("Suppression annul√©e.");
        }
    }
});

function updateMontant(qteCell) {
    const row = qteCell.closest('tr');
    if (!row) return;

    const prixCell = row.querySelector('.prix-cell');
    const fraisCell = row.querySelector('.frais-cell');
    const montantCell = row.querySelector('.montant-cell');
    if (!prixCell || !fraisCell || !montantCell) return;

    const qte = parseFloat(qteCell.textContent.replace(/\s/g, '').replace(',', '.')) || 0;
    const prix = parseFloat(prixCell.textContent.replace(/\s/g, '').replace(',', '.')) || 0;
    const frais = parseFloat(fraisCell.textContent.replace(/\s/g, '').replace(',', '.')) || 0;

    const montant = (qte * prix) + frais;

    // M√©thode de secours pour tester si Intl est le probl√®me
    montantCell.textContent = new Intl.NumberFormat('fr-FR', {
        minimumFractionDigits: 2, // Assure qu'il y a toujours 2 d√©cimales (ex: 123,00)
        maximumFractionDigits: 2  // Limite √† 2 d√©cimales
    }).format(montant);
}


console.log('=== SCRIPT CONFIGURE (d√©l√©gation d\'√©v√©nements) ===');
</script>