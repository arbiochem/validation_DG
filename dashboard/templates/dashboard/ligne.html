{% load l10n %}

<style>
    /* Table responsive */
    .table-wrapper {
        overflow-x: auto; /* Permet le scroll horizontal sur mobile */
        width: 100%;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 8px 10px;
        text-align: center;
        border: 1px solid #ccc;
        white-space: nowrap; /* Emp√™che le texte de casser en plusieurs lignes */
    }

    /* Couleurs pour la cellule editable */
    .qte-cell {
        background-color: #007BFF;
        color: white;
    }

    /* Boutons */
    .btn-action i, .btn-save {
        font-size: 16px;
    }

    /* Centrage */
    .text-center {
        text-align: center;
    }

    /* Responsive : r√©duire police et padding sur petits √©crans */
    @media (max-width: 768px) {
        th, td {
            padding: 6px 4px;
            font-size: 12px;
        }

        .btn-action i, .btn-save {
            font-size: 14px;
        }
    }

    @media (max-width: 480px) {
        th, td {
            padding: 4px 2px;
            font-size: 10px;
        }

        .btn-action i, .btn-save {
            font-size: 12px;
        }
    }
</style>


{% for ligne in lignes %}
    <tr class="ligne" data-id="{{ ligne.cbMarq }}" 
        data-prix="{{ ligne.DL_PrixUnitaire|floatformat:2|localize }}" 
        data-frais="{{ ligne.DL_Frais|floatformat:2|localize }}">
        <td>{{ ligne.AR_Ref }}</td>
        <td>{{ ligne.DL_DESIGN }}</td>
        <td class="qte-cell" contenteditable="true" 
            data-row-id="{{ ligne.cbMarq }}"
            style="text-align: center; background-color: blue; color:white">{{ ligne.DL_QTE|floatformat:2|localize }}</td>
        <td class="prix-cell" style="text-align: center;">{{ ligne.DL_PrixUnitaire|floatformat:2|localize }}</td>
        <td class="frais-cell" style="text-align: center;">{{ ligne.DL_Frais|floatformat:2|localize }}</td>
        <td class="montant-cell" data-row-id="{{ ligne.cbMarq }}" style="text-align: center;">{{ ligne.DL_MontantTTC|floatformat:2|localize }}</td>
        <td class="text-center">
            <button class="btn btn-sm btn-success btn-save" data-row-id="{{ ligne.cbMarq }}" type="button" title="Enregistrer">
                üíæ
            </button>
            <a href="#" class="btn btn-sm btn-danger btn-action btn-delete" data-row-id="{{ ligne.cbMarq }}" title="Supprimer">
                <i class="bi bi-trash"></i>
            </a>
        </td>
    </tr>
{% endfor %}

<script>
console.log('=== SCRIPT CHARGE ===');

// Utiliser la d√©l√©gation d'√©v√©nements sur le document
document.addEventListener('input', function(e) {
    // V√©rifier si c'est une cellule de quantit√©
    if (e.target && e.target.classList.contains('qte-cell')) {
        //console.log('Modification de quantit√© d√©tect√©e');
        
        const qteCell = e.target;
        const row = qteCell.closest('tr');
        
        if (!row) {
            console.error('Ligne parente non trouv√©e');
            return;
        }
        
        const prixCell = row.querySelector('.prix-cell');
        const fraisCell = row.querySelector('.frais-cell');
        const montantCell = row.querySelector('.montant-cell');
        
        if (!prixCell || !fraisCell || !montantCell) {
            console.error('Cellules non trouv√©es');
            return;
        }
        
        // R√©cup√©rer les valeurs
        const qteText = qteCell.textContent.trim();
        const prixText = prixCell.textContent.trim();
        const fraisText = fraisCell.textContent.trim();
        
        //console.log('Valeurs brutes:', { qte: qteText, prix: prixText, frais: fraisText });
        
        // Convertir en nombres
        const qte = parseFloat(qteText.replace(/\s/g, '').replace(',', '.')) || 0;
        const prix = parseFloat(prixText.replace(/\s/g, '').replace(',', '.')) || 0;
        const frais = parseFloat(fraisText.replace(/\s/g, '').replace(',', '.')) || 0;
        
        //console.log('Valeurs num√©riques:', { qte, prix, frais });
        
        // Calculer le montant
        const montant = (qte * prix) + frais;
        //console.log('Montant calcul√©:', montant);
        
        // Afficher le r√©sultat
        montantCell.textContent = new Intl.NumberFormat('fr-FR', { 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 2 
        }).format(montant);
        //console.log('Nouveau montant affich√©:', montantCell.textContent);
    }
});

// Gestion des clics sur les boutons save avec d√©l√©gation
document.addEventListener('click', function(e) {
    // V√©rifier si c'est un bouton save
    if (e.target && (e.target.classList.contains('btn-save') || e.target.closest('.btn-save'))) {
        e.preventDefault();
        
        const btn = e.target.classList.contains('btn-save') ? e.target : e.target.closest('.btn-save');
        const row = btn.closest('tr');
        
        if (!row) {
            console.error('Ligne non trouv√©e');
            return;
        }
        
        const id = row.dataset.id;
        //console.log('Sauvegarde ligne ID:', id);
        
        const data = {
            do_piece: "{{do_piece}}",
            AR_Ref: row.cells[0].textContent.trim(),
            DL_DESIGN: row.cells[1].textContent.trim(),
            DL_QTE: parseFloat(row.cells[2].textContent.replace(/\s/g, '').replace(',', '.')) || 0,
            DL_PrixUnitaire: parseFloat(row.cells[3].textContent.replace(/\s/g, '').replace(',', '.')) || 0,
            DL_Frais: parseFloat(row.cells[4].textContent.replace(/\s/g, '').replace(',', '.')) || 0,
            DL_MontantTTC: parseFloat(row.cells[5].textContent.replace(/\s/g, '').replace(',', '.')) || 0
        };
        
        //console.log('Donn√©es √† envoyer:', data);
        
        // Fonction pour r√©cup√©rer le cookie CSRF
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        ids = id.toString().trim();          // retire les espaces au d√©but/fin
        idss = ids.replace(/\s/g, '');

        fetch(`/dashboard/modifier_ligne/${idss}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(res => {
            if (!res.ok) throw new Error('Erreur serveur: ' + res.status);
            return res.json();
        })
        .then(res => {
            console.log('R√©ponse:', res);
            if(res.success){
                alert('Ligne mise √† jour avec succ√®s !');
            } else {
                alert('Erreur: ' + (res.message || 'Erreur inconnue'));
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur: ' + error.message);
        });
    }
    
    // Gestion du bouton supprimer
    if (e.target && (e.target.classList.contains('btn-delete') || e.target.closest('.btn-delete'))) {
        e.preventDefault();
        
        if (confirm('Voulez-vous vraiment supprimer cette ligne ?')) {
            const btn = e.target.classList.contains('btn-delete') ? e.target : e.target.closest('.btn-delete');
            const row = btn.closest('tr');
            const id = row.dataset.id;
            console.log('Suppression ligne ID:', id);

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // V√©rifie si ce cookie commence par le nom
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            ids = id.toString().trim();          // retire les espaces au d√©but/fin
            idss = ids.replace(/\s/g, '');

            fetch(`/dashboard/modifier_ligne/${idss}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(res => res.json())
            .then(res => {
                if(res.success){
                    alert("Ligne supprim√©e !");
                    location.reload();
                } else {
                    alert("Erreur : " + res.message);
                }
            });
        }
    }
});

console.log('=== SCRIPT CONFIGURE (d√©l√©gation d\'√©v√©nements) ===');
</script>